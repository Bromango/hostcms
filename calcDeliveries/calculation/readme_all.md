# Расчет стоимости популярных доставок для Hostcms 
Обертка для автоматического получения стоимости доставки для:
* SDEK (Сдэк) 
* Почта России
* BoxBerry (Боксбери) 
* OzonRecker (озонрикер) 

построенная для Hostcms 

### Использует следующие SDK:
 * [Boxberry](https://github.com/iamwildtuna/boxberry-sdk)
 * [DaData](https://github.com/hflabs/dadata-php)
 * [RussianPost](https://github.com/lapaygroup/RussianPost)
 * [CDEK](https://github.com/AntistressStore/cdek-sdk-v2)

### Что умеет:
* Определяет местоположение пользователя по IP адресу
* Расчитать стоимость доставки SDEK'ом
* Расчитать стоимость доставки Почтой России
* Расчитать стоимость доставки Боксбери (в разработке)
* Расчитать стоимость доставки ОзонРикер (в разработке)

### Как должен работать
В корневой шаблон (основной) в шапке сайта ставится метод определяющий местоположение пользоватеся. При первой загрузке метод ```Core_Entity::factory('Shop_Delivery_Calculation', 0)->getUserGeodata(); ``` определяет город пользователя, пишет данные в сессию и сохраняет в Куки.
При дальнейших загрузках страниц данные будут подгружаться из сессии, а при повторном посещении сайта в течении месяца, местоположение подгрузится из `cookies`.

Далее при помощи соответствующих методов расчитвыается стоимость доставки из пункта `A` в пункт `B`, где `A` указывается в файле `config.php`, а `B` - пункт назначения, берется из сессии (почтовый индекс и название города) или пользователь указывает сам на странице оформления заказа или карты товара. 


____
## Определяет местоположение пользователя по IP адресу
Определяет местоположение  пользователя по ip адресу при помощи сервисов: dadata.ru или ip-api.com и пишет полученные данные в сессию и куки. 

Требуется поправить данные в файле `config.php`
```php
    //Токен выдается после регистрации: https://dadata.ru/api/
    'dadata' => array('token' => '')
```
Получить местоположение пользователя
```php
    $_oGeodata = Core_Entity::factory('Shop_Delivery_Calculation', 0);

	// Отдает массив  с даными: 
	$_location = $_oGeodata->getUserGeodata();
	/* пример данных массива
	Array ( 
		[postal_code] => 344000 
		[city_name] => Ростов-на-Дону 
		[getUserGeodataType] => Cookie 
	)
	*/

    //Добавляет значение в текушую сессию, принимает чистое значение или массив
    $_oGeodata->addToSession($value, $name = false);
```
______
## Расчитать стоимость доставки SDEK'ом
Расчитать стоиммость сдэка 

конфигурационный файл

Если не передать почтовый индекс, метод будет искать почтовый индекс в сессии, если не найдет отдаст FALSE 

```php
    $_aSDEK = Core_Entity::factory('Shop_Delivery_Calculation', 0)
		->getPriceSdekDeliveryByPostcode();
```

________
## Получить идентификаторы города из БД доставок по почтовому индексу 

```php
	$postcode = '344000';
	$_aDeliveriesId = Core_Entity::factory('Shop_Delivery_Calculation', 0)
		->getDeliveryIdFromDB($postcode);
```
















